# Bash Formatting Standards

> RylanLabs Canonical shfmt Configuration  
> Version: 4.5.1  
> Guardian: Carter (Guardian)  
> Ministry: Configuration Management

---

## Overview

All RylanLabs bash scripts follow standardized formatting via `shfmt` to ensure consistency, readability, and compliance with the Seven Pillars.

## shfmt Configuration

### Canonical Arguments

```bash
shfmt -i 2 -ci -bn [OPTIONS] [FILE]
```

| Argument | Name | Purpose |
|----------|------|---------|
| `-i 2` | Indent | 2-space indentation (not 4, not tabs) |
| `-ci` | Case indent | Indent case statement patterns |
| `-bn` | Binary ops newline | Binary operators at line start |

### Rationale

**2-space indent (`-i 2`)**:
- Reduces excessive nesting depth visibility issues
- Aligns with Python/YAML 2-space standard (Trinity consistency)
- Balances clarity with file width constraints (120 chars max)

**Case indent (`-ci`)**:
```bash
# WITH -ci (correct)
case "$var" in
  pattern1)
    echo "Match 1"
    ;;
  pattern2)
    echo "Match 2"
    ;;
esac

# WITHOUT -ci (harder to read)
case "$var" in
pattern1)
  echo "Match 1"
  ;;
pattern2)
  echo "Match 2"
  ;;
esac
```

**Binary ops newline (`-bn`)**:
```bash
# WITH -bn (correct, operator leads new line)
if [[ -f "$file" ]] \
  && [[ -r "$file" ]]; then
  echo "File readable"
fi

# WITHOUT -bn (harder to scan)
if [[ -f "$file" ]] &&
  [[ -r "$file" ]]; then
  echo "File readable"
fi
```

---

## Usage

### Format Single File (in-place)

```bash
shfmt -i 2 -ci -bn -w script.sh
```

### Format Multiple Files

```bash
# Format all scripts/ directory
find scripts/ -name "*.sh" -exec shfmt -i 2 -ci -bn -w {} \;

# Format with dry-run (show diff without modifying)
find scripts/ -name "*.sh" -exec shfmt -i 2 -ci -bn -d {} \;
```

### Automatic Formatting on Commit (Pre-commit Hook)

```bash
# .git/hooks/pre-commit
#!/usr/bin/env bash
set -euo pipefail

echo "[pre-commit] Running shfmt..."
find scripts/ -name "*.sh" -exec shfmt -i 2 -ci -bn -w {} \;
git add scripts/
```

### CI/CD Integration

Validator script checks formatting without modifying files:

```bash
# scripts/validate-bash.sh (run in CI)
find scripts/ -name "*.sh" -exec shfmt -i 2 -ci -bn -d {} \;
```

---

## Integration with Trinity Validators

The canonical `scripts/validate-bash.sh` enforces shfmt standards:

```bash
# Local validation (before commit)
bash scripts/validate-bash.sh

# CI validation (on push)
# .github/workflows/trinity-ci.yml calls validate-bash.sh
```

---

## Exception Patterns

### When to Disable shfmt

Some edge cases may require bypassing shfmt:

**1. Auto-generated scripts**
```bash
#!/usr/bin/env bash
# AUTO-GENERATED by tool-x
# DO NOT MANUALLY EDIT
# shfmt disabled for this file
#
# Generated: {{ generated_date }}
# Tool: {{ generator_tool }}
```

**2. Embedded scripts with specific formatting**
```bash
#!/usr/bin/env bash
# shfmt: disable
# This script must maintain original formatting for compatibility
...
# shfmt: enable
```

Document rationale in comments above the script.

---

## Migration Guide: Applying to Existing Scripts

### Step 1: Dry-run to see changes

```bash
shfmt -i 2 -ci -bn -d scripts/*.sh | head -50
```

### Step 2: Review changes

Look for unexpected transformations. Common changes:

- 4-space indent â†’ 2-space
- `case` patterns align inward
- Multi-line conditions restructured

### Step 3: Apply formatting

```bash
find scripts/ -name "*.sh" -exec shfmt -i 2 -ci -bn -w {} \;
```

### Step 4: Commit with notes

```bash
git add scripts/
git commit -m "chore(scripts): apply shfmt standardization (v4.5.1)

- Standardize indentation to 2 spaces
- Enable case statement indentation
- Binary operators at line start
- Aligns with Trinity configuration management standards"
```

---

## References

- [shfmt Documentation](https://github.com/mvdan/sh)
- [Bash Discipline](bash-discipline.md)
- [Seven Pillars](seven-pillars.md)
- [CI Workflow Guide](.github/workflows/ci-workflow-guide.md)
