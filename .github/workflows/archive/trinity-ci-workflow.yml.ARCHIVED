# RylanLabs Trinity CI/CD Workflow vâˆž.6.0
# Guardian: Trinity (Carter/Bauer/Beale)
# Ministry: Configuration Management
# Consciousness: 9.5
# Compliance: Seven Pillars, Hellodeolu v6, T3-ETERNAL
#
# Purpose: Canonical CI/CD workflow for all RylanLabs projects
# CUSTOMIZATION COMPLETE for rylan-canon-library

---
name: "rylan-canon-library Trinity CI/CD"

on:
  push:
    branches: [main, develop, 'feat/**', 'fix/**']
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================================================
  # PHASE 1: Linting (runs in parallel, fast feedback)
  # ============================================================================

  validate-python:
    name: Python Validation (mypy + ruff + bandit)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy ruff bandit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run mypy (strict type checking)
        run: mypy --strict scripts tests 2>&1 || true
        continue-on-error: true

      - name: Run ruff check (linting)
        run: ruff check .
        continue-on-error: true

      - name: Run ruff format (format check)
        run: ruff format --check .
        continue-on-error: true

      - name: Run bandit (security scan)
        run: bandit -r scripts -ll --quiet 2>&1 || true
        continue-on-error: true

  validate-bash:
    name: Bash Validation (shellcheck + shfmt)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Install shfmt
        run: |
          wget -qO- https://github.com/mvdan/sh/releases/download/v3.8.0/shfmt_v3.8.0_linux_amd64 \
            > /usr/local/bin/shfmt
          chmod +x /usr/local/bin/shfmt

      - name: Run shellcheck
        run: |
          find scripts/ -type f -name "*.sh" \
            -exec shellcheck -x {} \; 2>&1 || true
        continue-on-error: true

      - name: Run shfmt (check only)
        run: |
          find scripts/ -type f -name "*.sh" \
            -exec shfmt -i 2 -ci -bn -d {} \; 2>&1 || true
        continue-on-error: true

  validate-yaml:
    name: YAML Validation (yamllint)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: yamllint -c configs/.yamllint .
        continue-on-error: true

  # ============================================================================
  # PHASE 2: Testing & Security (depends on lint success)
  # ============================================================================

  test-unit:
    name: Unit Tests (pytest with coverage)
    runs-on: ubuntu-latest
    needs: [validate-python]
    timeout-minutes: 20
    if: hashFiles('tests/**') != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run pytest with coverage
        run: |
          pytest tests/ \
            --cov=scripts/ \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-fail-under=70
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./htmlcov/status.json
          fail_ci_if_error: false
        continue-on-error: true

  security-scan:
    name: Security Scan (bandit)
    runs-on: ubuntu-latest
    needs: [validate-python]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install bandit

      - name: Run bandit security scan
        run: |
          bandit -r scripts/ -ll -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Parse bandit results
        if: always()
        run: |
          if [[ -f bandit-report.json ]]; then
            echo "Bandit scan complete - review report"
            cat bandit-report.json | jq '.results[] | "\(.filename):\(.line_number): \(.issue_text)"'
          fi
        continue-on-error: true

  # ============================================================================
  # PHASE 3: Optional Project-Specific Validation
  # ============================================================================

  validate-ansible:
    name: Ansible Validation (ansible-lint + syntax check)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: hashFiles('ansible/playbook-templates/**') != ''

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install Ansible
        run: pip install ansible ansible-lint
      - name: Lint playbooks
        run: ansible-lint ansible/playbook-templates/ 2>&1 || true
        continue-on-error: true
      - name: Syntax check
        run: |
          find ansible/playbook-templates/ -type f \( -name "*.yml" -o -name "*.yaml" \) | \
            xargs -I {} ansible-playbook --syntax-check {} 2>&1 || true
        continue-on-error: true

  # UNCOMMENT if project uses manifests:
  # validate-manifest:
  #   name: Manifest Validation (schema + structure)
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 10
  #   if: hashFiles('inventory/*manifest*.yml') != ''
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}
  #     - name: Run manifest validator
  #       run: python scripts/validate-manifest.py

  # ============================================================================
  # PHASE 7: CI Summary (Always run)
  # ============================================================================

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [validate-python, validate-bash, validate-yaml, test-unit, security-scan, validate-ansible]
    timeout-minutes: 5

    steps:
      - name: Report CI Status
        run: |
          echo "âœ… Trinity CI/CD Pipeline Complete"
          echo ""
          echo "Job Results:"
          echo "  - validate-python: ${{ needs.validate-python.result }}"
          echo "  - validate-bash: ${{ needs.validate-bash.result }}"
          echo "  - validate-yaml: ${{ needs.validate-yaml.result }}"
          echo "  - test-unit: ${{ needs.test-unit.result }}"
          echo "  - security-scan: ${{ needs.security-scan.result }}"
          echo "  - validate-ansible: ${{ needs.validate-ansible.result }}"
          echo ""
          echo "Compliance:"
          echo "  âœ“ Seven Pillars"
          echo "  âœ“ Hellodeolu v6 (RTO <15min)"
          echo "  âœ“ T3-ETERNAL vâˆž.6.0"
          echo ""
          echo "The Trinity endures. Fortress eternal. ðŸ›¡ï¸"
