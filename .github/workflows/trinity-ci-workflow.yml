# RylanLabs Trinity CI/CD Template
# Version: 4.5.1
# Guardian: Bauer (Auditor)
# Ministry: Configuration Management
#
# Purpose: Canonical CI/CD workflow for all RylanLabs projects
# Compliance: Seven Pillars, Hellodeolu v6, T3-ETERNAL
#
# CUSTOMIZATION GUIDE:
# 1. Copy this file to .github/workflows/trinity-ci.yml
# 2. Replace {{ PLACEHOLDERS }} with project-specific values
# 3. Remove optional jobs (validate-ansible, validate-manifest) if not needed
# 4. Add secrets to GitHub repo: Settings > Secrets and variables > Actions
#
# PLACEHOLDERS:
#   {{ PROJECT_NAME }}        - Repository name (e.g., rylan-inventory)
#   {{ PYTHON_VERSION }}      - Python version (default: 3.11)
#   {{ MYPY_PATHS }}          - Paths for mypy (default: scripts/ tests/)
#   {{ RUFF_PATHS }}          - Paths for ruff (default: .)
#   {{ BASH_PATHS }}          - Paths for bash scripts (default: scripts/)
#   {{ YAML_PATHS }}          - Paths for YAML files (default: .)
#   {{ COV_PATHS }}           - Coverage paths (default: scripts/)
#   {{ COV_THRESHOLD }}       - Minimum coverage % (default: 70)
#   {{ BANDIT_PATHS }}        - Security scan paths (default: scripts/)

---
name: "{{ PROJECT_NAME }} Trinity CI/CD"

on:
  push:
    branches: [main, develop, 'feat/**', 'fix/**']
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: "{{ PYTHON_VERSION | default: '3.11' }}"
  # Project-specific environment variables
  # {{ CUSTOM_ENV_VARS }}

jobs:
  # ============================================================================
  # PHASE 1: Linting (runs in parallel, fast feedback)
  # ============================================================================

  validate-python:
    name: Python Validation (mypy + ruff)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python {{ PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy ruff bandit
          # Install project dependencies if requirements.txt exists
          [[ -f requirements.txt ]] && pip install -r requirements.txt || true

      - name: Run mypy (strict type checking)
        run: "mypy --strict {{ MYPY_PATHS | default: 'scripts/ tests/' }}"

      - name: Run ruff check (linting)
        run: "ruff check {{ RUFF_PATHS | default: '.' }}"

      - name: Run ruff format (format check)
        run: "ruff format --check {{ RUFF_PATHS | default: '.' }}"

  validate-bash:
    name: Bash Validation (shellcheck + shfmt)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Install shfmt
        run: |
          wget -qO- https://github.com/mvdan/sh/releases/download/v3.8.0/shfmt_v3.8.0_linux_amd64 \
            > /usr/local/bin/shfmt
          chmod +x /usr/local/bin/shfmt

      - name: Run shellcheck
        run: |
          find {{ BASH_PATHS | default: 'scripts/' }} -type f -name "*.sh" \
            -exec shellcheck -x {} \;

      - name: Run shfmt (check only)
        run: |
          find {{ BASH_PATHS | default: 'scripts/' }} -type f -name "*.sh" \
            -exec shfmt -i 2 -ci -bn -d {} \;

  validate-yaml:
    name: YAML Validation (yamllint)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: "yamllint -c configs/.yamllint {{ YAML_PATHS | default: '.' }}"

  # ============================================================================
  # PHASE 2: Testing & Security (depends on lint success)
  # ============================================================================

  test-unit:
    name: Unit Tests (pytest with coverage)
    runs-on: ubuntu-latest
    needs: [validate-python]
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python {{ PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          [[ -f requirements.txt ]] && pip install -r requirements.txt || true

      - name: Run pytest with coverage
        run: |
          pytest tests/ \
            --cov={{ COV_PATHS | default: 'scripts/' }} \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-fail-under={{ COV_THRESHOLD | default: '70' }}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./htmlcov/status.json
          fail_ci_if_error: false

  security-scan:
    name: Security Scan (bandit)
    runs-on: ubuntu-latest
    needs: [validate-python]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python {{ PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install bandit

      - name: Run bandit security scan
        run: |
          bandit -r {{ BANDIT_PATHS | default: 'scripts/' }} -ll -f json -o bandit-report.json || true

      - name: Parse bandit results
        if: always()
        run: |
          if [[ -f bandit-report.json ]]; then
            echo "Bandit scan complete - review report"
            cat bandit-report.json | jq '.results[] | "\(.filename):\(.line_number): \(.issue_text)"'
          fi

  # ============================================================================
  # PHASE 3: Optional Project-Specific Validation
  # ============================================================================

  # UNCOMMENT if project uses Ansible:
  # validate-ansible:
  #   name: Ansible Validation (ansible-lint + syntax check)
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 15
  #   if: hashFiles('playbooks/**') != ''
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}
  #     - name: Install Ansible
  #       run: pip install ansible ansible-lint
  #     - name: Lint playbooks
  #       run: ansible-lint playbooks/
  #     - name: Syntax check
  #       run: |
  #         find playbooks/ -type f -name "*.yml" -o -name "*.yaml" | \
  #           xargs -I {} ansible-playbook --syntax-check {}

  # UNCOMMENT if project uses manifests:
  # validate-manifest:
  #   name: Manifest Validation (schema + structure)
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 10
  #   if: hashFiles('inventory/*manifest*.yml') != ''
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}
  #     - name: Run manifest validator
  #       run: python scripts/validate-manifest.py

  # ============================================================================
  # FINAL: Summary Job (requires all phases)
  # ============================================================================

  ci-complete:
    name: CI Status Summary
    runs-on: ubuntu-latest
    needs: [validate-python, validate-bash, validate-yaml, test-unit, security-scan]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Check job results
        run: |
          if [[ "${{ needs.validate-python.result }}" != "success" ]] || \
             [[ "${{ needs.validate-bash.result }}" != "success" ]] || \
             [[ "${{ needs.validate-yaml.result }}" != "success" ]] || \
             [[ "${{ needs.test-unit.result }}" != "success" ]]; then
            echo "❌ CI pipeline failed - review errors above"
            exit 1
          fi
          echo "✅ All CI checks passed"

      - name: Comment on PR (success)
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ All Trinity CI checks passed!\n- Linting: ✓\n- Testing: ✓\n- Security: ✓'
            })
