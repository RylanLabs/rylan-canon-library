---
# RylanLabs Trinity CI (Consensus Gate)
# Maturity: Level 5 (Autonomous)
# Guardian: Bauer (Auditor)
# Ministry: Configuration Management

name: "Trinity CI"

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  pull-requests: write

jobs:
  governance-gate:
    name: "Trinity Governance Consensus"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install System Dependencies
        run: sudo apt-get update && sudo apt-get install -y shellcheck shfmt jq bc

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy bandit pyyaml types-pyyaml yamllint ansible-lint

      - name: Run Bauer Validation Suite
        run: |
          make ci-validate-all

      - name: Post PR Summary
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const summaryPath = '.audit/ci-summary.json';
            if (fs.existsSync(summaryPath)) {
              const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
              let comment = '### ğŸ›¡ï¸ Trinity Consensus Gate Summary\n\n';
              const statusIcon = summary.status === 'pass' ? 'âœ…' : 'âŒ';
              comment += \`**Status:** \${statusIcon} \${summary.status.toUpperCase()}\n\`;
              comment += \`**Duration:** \${summary.duration_ms}ms\n\n\`;
              if (summary.violations && summary.violations.length > 0) {
                comment += '| Severity | Type | Message | Source |\n';
                comment += '| :--- | :--- | :--- | :--- |\n';
                summary.violations.forEach(v => {
                  const sevIcon = v.severity === 'critical' ? 'ğŸ”´' : 'ğŸŸ¡';
                  comment += \`| \${sevIcon} \${v.severity} | \${v.type} | \${v.message} | \${v.source_file} |\n\`;
                });
              } else {
                comment += 'âœ¨ All governance standards verified. Consensus reached.\n';
              }
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Enforce Consensus Gate
        run: |
          if [ -f .audit/ci-summary.json ]; then
            STATUS=$(jq -r '.status' .audit/ci-summary.json)
            if [ "$STATUS" != "pass" ]; then
              echo "âŒ Bauer Consensus Failed: Critical violations detected."
              exit 1
            fi
            echo "âœ… Bauer Consensus Reached."
          else
            echo "âŒ Bauer Summary Missing: Validation failed to complete."
            exit 1
          fi
