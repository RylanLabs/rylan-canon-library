---
# Playbook: backup-controller.yml
# Purpose: Backup UniFi network controller with retention policy
# Guardian: Bauer (Verification)
# Version: v1.0.0
# Compliance: Seven Pillars, Hellodeolu v6, T3-ETERNAL

- name: "Backup UniFi Controller"
  hosts: unifi_controller
  gather_facts: true
  vars:
    backup_retention_days: 30
    backup_dir: "/var/backups/unifi"
    audit_dir: ".audit/phase-3-playbooks"
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    backup_filename: "unifi-backup-{{ timestamp }}.tar.gz"

  tasks:
    # PHASE 1: GATHER
    - name: "GATHER : Fetch controller health and state"
      uri:
        url: "https://{{ inventory_hostname }}:8443/api/s/default"
        method: GET
        user: "{{ unifi_user }}"
        password: "{{ unifi_password }}"
        validate_certs: false
      register: controller_health
      tags: [gather]

    # PHASE 2: PROCESS
    - name: "PROCESS : Prepare backup environment"
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0750'
      tags: [process]

    # PHASE 3: APPLY
    - name: "APPLY : Trigger UniFi API backup request"
      uri:
        url: "https://{{ inventory_hostname }}:8443/api/s/default/cmd/backup"
        method: POST
        user: "{{ unifi_user }}"
        password: "{{ unifi_password }}"
        validate_certs: false
      tags: [apply]

    # PHASE 4: VERIFY
    - name: "VERIFY : Check backup file existence and integrity"
      stat:
        path: "/data/backup/unifi-backup.unf"
      register: backup_file
      failed_when: not backup_file.stat.exists
      tags: [verify]

    # PHASE 5: AUDIT
    - name: "AUDIT : Log backup event"
      lineinfile:
        path: "{{ audit_dir }}/backup-history.log"
        line: "BACKUP: {{ backup_filename }} created on {{ inventory_hostname }} at {{ timestamp }}"
        create: yes
      delegate_to: localhost
      tags: [audit]

    # PHASE 6: REPORT
    - name: "REPORT : Notify backup success"
      debug:
        msg: "Backup {{ backup_filename }} completed successfully"
      tags: [report]

    # PHASE 7: FINALIZE
    - name: "FINALIZE : Execute retention cleanup"
      shell: "find {{ backup_dir }} -type f -mtime +{{ backup_retention_days }} -delete"
      tags: [finalize]
