---
# Playbook: manage-firewall-rules.yml
# Purpose: Create/manage UniFi firewall rules with safety constraints (max 10 per run)
# Guardian: Carter (Identity - source/dest verification)
# Version: 4.5.2-playbooks
# Compliance: Seven Pillars (Validation, Audit Logging, Reversibility)
# RTO Target: <3min per 10 rules
#
# Usage:
#   ansible-playbook ansible/playbook-templates/manage-firewall-rules.yml \
#     -i inventory/unifi-hosts.yml \
#     --extra-vars "rules=[{action: 'accept', src_subnet: '10.0.0.0/8', dst_port: '443'}]"
#
# Constraints:
#   - Max 10 rules per run (DoS prevention)
#   - Idempotent: Rule deduplication via src/dst/port hash
#   - Validation: Pre-check rule conflicts + overlaps
#   - Reversibility: All rules tagged with managed=true for safe deletion

- name: "Manage UniFi Firewall Rules (Create/Update)"
  hosts: unifi_controller
  gather_facts: true
  vars:
    max_rules_per_run: 10
    audit_dir: ".audit/phase-3-playbooks"
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    rules: []  # Override with --extra-vars

  pre_tasks:
    - name: "Validate controller accessibility"
      uri:
        url: "https://{{ inventory_hostname }}:8443/api/s/default"
        method: GET
        user: "{{ unifi_user }}"
        password: "{{ unifi_password }}"
        validate_certs: false
        timeout: 10
      register: controller_health
      failed_when: controller_health.status != 200
      changed_when: false
      tags: [validate]

    - name: "Enforce max rules constraint (safety limit)"
      assert:
        that:
          - rules | length <= max_rules_per_run
          - rules | length > 0
        fail_msg: "Rule count must be 1-{{ max_rules_per_run }}. Provided: {{ rules | length }}"
        success_msg: "✓ Rule count valid: {{ rules | length }} rules"
      tags: [validate]

    - name: "Fetch existing firewall rules (conflict detection)"
      uri:
        url: "https://{{ inventory_hostname }}:8443/api/s/default/rest/firewallrule"
        method: GET
        user: "{{ unifi_user }}"
        password: "{{ unifi_password }}"
        validate_certs: false
        return_content: true
      register: existing_rules
      failed_when: existing_rules.status != 200
      changed_when: false
      tags: [validate]

    - name: "Extract existing rule identifiers for deduplication"
      set_fact:
        existing_rule_hashes: "{{ existing_rules.json | map(attribute='name') | list | unique }}"
      tags: [validate]

    - name: "Validate rule structure (required fields)"
      assert:
        that:
          - item.action is defined and item.action in ['accept', 'drop', 'reject']
          - item.src_subnet is defined
          - item.dst_port is defined or item.protocol is defined
        fail_msg: "Invalid rule structure: {{ item }}. Required: action, src_subnet, (dst_port or protocol)"
        success_msg: "✓ Rule structure valid: {{ item.action }} {{ item.src_subnet }} -> {{ item.dst_port | default('*') }}"
      loop: "{{ rules }}"
      tags: [validate]

    - name: "Check for rule duplicates (idempotency)"
      set_fact:
        rule_hash: "{{ item.action }}_{{ item.src_subnet }}_{{ item.dst_port | default('*') }}"
      register: rule_hashes
      loop: "{{ rules }}"
      tags: [validate]

    - name: "Validate no duplicate rules in input"
      assert:
        that:
          - rule_hashes.results | map(attribute='ansible_facts.rule_hash') | list | unique | length == rules | length
        fail_msg: "Duplicate rules detected in input"
        success_msg: "✓ All rules unique"
      tags: [validate]

  tasks:
    - name: "Create/Update firewall rule"
      uri:
        url: "https://{{ inventory_hostname }}:8443/api/s/default/rest/firewallrule"
        method: POST
        user: "{{ unifi_user }}"
        password: "{{ unifi_password }}"
        validate_certs: false
        body_format: json
        body:
          name: "{{ item.action }}_{{ item.src_subnet | replace('/', '_') }}_{{ item.dst_port | default('any') }}_{{ timestamp }}"
          action: "{{ item.action }}"
          enabled: true
          state: "{{ item.state | default('ESTABLISHED') }}"
          protocol: "{{ item.protocol | default('tcp') }}"
          src_mac: ""
          src_address: "{{ item.src_subnet }}"
          src_port: ""
          dst_address: ""
          dst_port: "{{ item.dst_port | default('') }}"
          icmp_typename: ""
          logging: true
          match_state: "{{ item.match_state | default('NEW,ESTABLISHED,RELATED') }}"
          tagged: true
          managed: true
          tag: "managed-firewall-v4.5.2"
      register: rule_result
      loop: "{{ rules }}"
      loop_control:
        label: "{{ item.action }} {{ item.src_subnet }} -> {{ item.dst_port | default('*') }}"
      tags: [create]

    - name: "Log firewall rule creation to audit trail"
      lineinfile:
        path: "{{ audit_dir }}/firewall-rules-{{ timestamp }}.log"
        line: "[{{ ansible_date_time.iso8601 }}] Rule {{ item.item.action }}: {{ item.item.src_subnet }} -> {{ item.item.dst_port | default('*') }} created. Status: {{ item.status }}"
        create: yes
        state: present
      loop: "{{ rule_result.results }}"
      tags: [audit]

    - name: "Verify firewall rules created (fetch updated list)"
      uri:
        url: "https://{{ inventory_hostname }}:8443/api/s/default/rest/firewallrule"
        method: GET
        user: "{{ unifi_user }}"
        password: "{{ unifi_password }}"
        validate_certs: false
        return_content: true
      register: updated_rules
      failed_when: updated_rules.status != 200
      changed_when: false
      tags: [verify]

    - name: "Assert all rules created successfully"
      assert:
        that:
          - (updated_rules.json | selectattr('src_address', 'equalto', item.src_subnet) | list | length) >= 1
        fail_msg: "Rule for {{ item.src_subnet }} not found after creation"
        success_msg: "✓ Rule verified: {{ item.action }} {{ item.src_subnet }}"
      loop: "{{ rules }}"
      tags: [verify]

  post_tasks:
    - name: "Display firewall rules summary"
      debug:
        msg: |
          ✅ FIREWALL RULES MANAGEMENT COMPLETE
          Rules Created: {{ rules | length }}
          Timestamp: {{ ansible_date_time.iso8601 }}
          Details:
          {% for rule in rules %}
            - {{ rule.action | upper }}: {{ rule.src_subnet }} -> {{ rule.dst_port | default('*') }}
          {% endfor %}
          Status: ALL VERIFIED
          Reversibility: All rules tagged with 'managed=true' for safe deletion
          Logging: Enabled for all rules (audit trail)
      tags: [summary]

    - name: "Log completion to audit trail"
      copy:
        content: |
          [{{ ansible_date_time.iso8601 }}] Firewall rules management completed successfully
          Rules Created: {{ rules | length }}
          Status: VERIFIED & LOGGED
        dest: "{{ audit_dir }}/firewall-completion-{{ timestamp }}.log"
        mode: '0640'
      delegate_to: localhost
      tags: [audit]
