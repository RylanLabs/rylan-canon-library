---
# Playbook: manage-vlans.yml
# Purpose: Create/manage UniFi VLANs with validation constraints (max 5 per run)
# Guardian: Bauer (Verification)
# Version: v1.0.0
# Compliance: Seven Pillars, Hellodeolu v6, T3-ETERNAL

- name: "Manage UniFi VLANs (Create/Update)"
  hosts: unifi_controller
  gather_facts: true
  vars:
    max_vlans_per_run: 5
    audit_dir: ".audit/phase-3-playbooks"
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    vlans: []

  tasks:
    # PHASE 1: GATHER
    - name: "GATHER : Fetch existing VLANs from controller"
      uri:
        url: "https://{{ inventory_hostname }}:8443/api/s/default/rest/networkconf"
        method: GET
        user: "{{ unifi_user }}"
        password: "{{ unifi_password }}"
        validate_certs: false
        return_content: true
      register: existing_networks
      failed_when: existing_networks.status != 200
      changed_when: false
      tags: [gather]

    # PHASE 2: PROCESS
    - name: "PROCESS : Validate VLAN count and conflicts"
      block:
        - name: "PROCESS : Enforce max VLANs constraint"
          assert:
            that:
              - vlans | length <= max_vlans_per_run
            fail_msg: "Max {{ max_vlans_per_run }} VLANs allowed."

        - name: "PROCESS : Check for VLAN ID conflicts"
          assert:
            that:
              - item.id not in (existing_networks.json | map(attribute='vlan') | list)
            fail_msg: "VLAN ID {{ item.id }} already exists."
          loop: "{{ vlans }}"
      tags: [process]

    # PHASE 3: APPLY
    - name: "APPLY : Create/Update UniFi VLAN"
      uri:
        url: "https://{{ inventory_hostname }}:8443/api/s/default/rest/networkconf"
        method: POST
        body_format: json
        body:
          vlan: "{{ item.id }}"
          name: "{{ item.name }}"
          subnet: "{{ item.subnet }}"
          managed: true
        user: "{{ unifi_user }}"
        password: "{{ unifi_password }}"
        validate_certs: false
        status_code: 201
      loop: "{{ vlans }}"
      tags: [apply]

    # PHASE 4: VERIFY
    - name: "VERIFY : Confirm VLAN activation"
      uri:
        url: "https://{{ inventory_hostname }}:8443/api/s/default/rest/networkconf"
        method: GET
        user: "{{ unifi_user }}"
        password: "{{ unifi_password }}"
        validate_certs: false
      register: verify_vlans
      failed_when: verify_vlans.status != 200
      tags: [verify]

    # PHASE 5: AUDIT
    - name: "AUDIT : Log VLAN creation"
      copy:
        content: "CREATED: {{ vlans | length }} VLANs on {{ inventory_hostname }} at {{ timestamp }}"
        dest: "{{ audit_dir }}/vlan-apply-{{ timestamp }}.log"
      delegate_to: localhost
      tags: [audit]

    # PHASE 6: REPORT
    - name: "REPORT : Output success"
      debug:
        msg: "Successfully processed {{ vlans | length }} VLANs"
      tags: [report]

    # PHASE 7: FINALIZE
    - name: "FINALIZE : Execution complete"
      debug:
        msg: "VLAN management finished"
      tags: [finalize]
